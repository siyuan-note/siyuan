name: after CI/CD change to release

on:
  workflow_dispatch:
  release:
    types: [released]
    # https://docs.github.com/zh/actions/using-workflows/events-that-trigger-workflows#release
    # æ³¨æ„ï¼šè§¦å‘ä½¿ç”¨çš„é…ç½®æ˜¯ released æ—¶çš„ aci.yml å†…å®¹ï¼Œä¸Žä¸»åˆ†æ”¯æˆ–è€…åŽç»­æ›´æ–°æ— å…³ã€‚

# ref https://docs.github.com/zh/actions/learn-github-actions/variables
env:
    repo_name: "siyuan"
    repo_owner: "siyuan-note"
    name_MD5: "Assets_MD5_Sum.txt"
    name_SHA256: "Assets_SHA256_Sum.txt"

jobs:
  release_action:
    runs-on: ubuntu-latest
    name: Release Action
    steps:
    - name: ðŸš€ Install dependencies
      run: npm install axios
    - name: ðŸ§² Get Latest Release Assets
      id: latest_release
      uses: actions/github-script@v7
      with:
          result-encoding: string
          retries: 3
          debug: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const axios = require('axios');
            const fs = require('fs');
            const { data } = await github.rest.repos.getLatestRelease({ owner: '${{ env.repo_owner }}', repo: '${{ env.repo_name }}' });
            async function downloadAsset(asset) {
                const url = asset.browser_download_url;
                const path = `${asset.name}`;
                console.log(`Downloading ${url} to${path}`);
                const response = await axios({
                url,
                method: 'GET',
                responseType: 'stream',
                });
                await new Promise((resolve, reject) => {
                const writer = response.data.pipe(fs.createWriteStream(path));
                writer.on('finish', resolve);
                writer.on('error', reject);
                });
                console.log(`Downloaded ${path}`);
            }
            await Promise.all(data.assets.map(downloadAsset));
            return data.upload_url;
      continue-on-error: false

    - name: ðŸ’¥ Generate Hash for Assets
      id: generate_hash
      # ä½¿ç”¨äº† awk çš„å†…ç½®å‡½æ•° toupper() æ¥å°†å“ˆå¸Œå€¼è½¬æ¢ä¸ºå¤§å†™ï¼ŒåŒæ—¶ä½¿ç”¨ç©ºæ ¼ä½œä¸ºå­—æ®µåˆ†éš”ç¬¦ã€‚awk ä¼šå°†æ¯ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªå­—æ®µï¼ˆå“ˆå¸Œå€¼ï¼‰è½¬æ¢ä¸ºå¤§å†™ï¼Œå¹¶ä¸”ä¿ç•™ç¬¬äºŒä¸ªå­—æ®µï¼ˆæ–‡ä»¶åï¼‰
      run: |
          ls
          find . -type f -name '${{ env.repo_name }}-*' -exec md5sum {} + | awk '{print toupper($1), $2}' > ${{ env.name_MD5 }}
          find . -type f -name '${{ env.repo_name }}-*' -exec sha256sum {} + | awk '{print toupper($1), $2}' > ${{ env.name_SHA256 }}
      continue-on-error: false

    - name: ðŸ“¤ Upload Assets_MD5_Sum.txt File to Release Asset
      uses: shogo82148/actions-upload-release-asset@v1
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ steps.latest_release.outputs.result }}
          asset_path: ./${{ env.name_MD5 }}
          asset_name: ${{ env.name_MD5 }}

    - name: ðŸ“¤ Upload Assets_SHA256_Sum.txt File to Release Asset
      uses: shogo82148/actions-upload-release-asset@v1
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ steps.latest_release.outputs.result }}
          asset_path: ./${{ env.name_SHA256 }}
          asset_name: ${{ env.name_SHA256 }}
